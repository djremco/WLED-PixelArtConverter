<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>WLED Pixel Art Converter</title>

  <style>
    body{
      font-family:Arial,sans-serif;
      background:#111;
      color:#ddd;
      margin:0;
      padding:20px;
    }
    .container{max-width:800px;margin:auto;text-align:center}
    h1{display:flex;align-items:center;justify-content:center;gap:10px}
    table{width:100%;margin-bottom:10px;border-collapse:collapse}
    td{padding:5px;vertical-align:middle}
    input,select,button{
      background:#222;border:1px solid #333;color:#ddd;
      border-radius:6px;font-size:14px;padding:4px 6px;
    }
    #drop-zone{
      border:2px dashed #777;padding:18px;margin:15px 0;cursor:pointer;
      color:#888;
    }
    textarea{
      width:100%;height:250px;background:#222;color:#ddd;
      border:1px solid #333;border-radius:6px;padding:8px;
      font-family:monospace;
    }
    #pixelCanvas{width:100%;background:#000;border:1px solid #333;margin-top:10px}
    .button-row{display:flex;gap:10px;margin-top:10px}
    .button-row button{flex:1}
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ§© WLED Pixel Art Converter</h1>
  <h2>Convert image to WLED JSON (full feature set + vertical serpentine)</h2>

  <table id="fieldTable">
    <tr>
      <td><label for="ledSetupSelector">LED setup:</label></td>
      <td>
        <select id="ledSetupSelector">
          <option value="matrix" selected>2Dâ€¯Matrixâ€¯(horizontal)</option>
          <option value="r2l">Serpentine â€“ first row â†’â€¯left</option>
          <option value="l2r">Serpentine â€“ first row â†’â€¯right</option>
          <option value="matrix_v_serp">Vertical serpentineâ€¯(topâ€‘bottomâ€¯â†‘â†“)</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Output format:</label></td>
      <td>
        <select id="outputMode">
          <option value="wled" selected>WLEDâ€¯JSON</option>
          <option value="curl">CURL</option>
          <option value="ha">Homeâ€¯Assistantâ€¯YAML</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Color format:</label></td>
      <td>
        <select id="colorFormat">
          <option value="hex" selected>HEXâ€¯("RRGGBB")</option>
          <option value="dec">DECâ€¯(R,G,B)</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Addressingâ€¯mode:</label></td>
      <td>
        <select id="addressingMode">
          <option value="single">Single</option>
          <option value="range">Rangeâ€¯(start,end,color)</option>
          <option value="hybrid" selected>Hybridâ€¯(color,start,end,color)</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Brightness:</label></td>
      <td><input type="range" id="brightness" min="1" max="255" value="128"></td>
    </tr>
    <tr>
      <td><label>Maxâ€¯colorsâ€¯/â€¯JSON:</label></td>
      <td><input type="number" id="colorLimit" min="1" max="512" value="256"></td>
    </tr>
    <tr>
      <td><label>Widthâ€¯(px):</label></td>
      <td><input type="number" id="sizeX" value="23"></td>
    </tr>
    <tr>
      <td><label>Heightâ€¯(px):</label></td>
      <td><input type="number" id="sizeY" value="26"></td>
    </tr>
    <tr>
      <td><label>WLEDâ€¯IPâ€¯address:</label></td>
      <td><input type="text" id="deviceIP" value="192.168.0.100"></td>
    </tr>
    <tr>
      <td><label>Segmentâ€¯ID:</label></td>
      <td><input type="number" id="segmentID" value="0"></td>
    </tr>
  </table>
  <div id="drop-zone">Dropâ€¯imageâ€¯hereâ€¯orâ€¯clickâ€¯toâ€¯select</div>
  <input type="file" id="file-picker" style="display:none">

  <canvas id="pixelCanvas"></canvas>
  <textarea id="JSONled" readonly></textarea>

  <div class="button-row">
    <button id="copyJSON">Copyâ€¯Output</button>
    <button id="downloadJSON">Downloadâ€¯Output</button>
  </div>

  <p style="color:#666;margin-top:10px">
    v2.0 â€“ rebuilt from Werkstromâ€¯1.0.8â€¯+â€¯Verticalâ€¯Serpentine byâ€¯[you]
  </p>
</div>
<script>
const d=document;
function gId(id){return d.getElementById(id);}
const canvas=gId('pixelCanvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const dropZone=gId('drop-zone');
const filePicker=gId('file-picker');
const output=gId('JSONled');

dropZone.addEventListener('click',()=>filePicker.click());
filePicker.addEventListener('change',e=>loadImage(e.target.files[0]));
dropZone.addEventListener('dragover',e=>e.preventDefault());
dropZone.addEventListener('drop',e=>{e.preventDefault();loadImage(e.dataTransfer.files[0]);});

function loadImage(file){
  const r=new FileReader();
  r.onload=()=>{const img=new Image();img.onload=()=>getPixelRGBValues(img);img.src=r.result;};
  r.readAsDataURL(file);
}

gId('copyJSON').addEventListener('click',()=>navigator.clipboard.writeText(output.value));
gId('downloadJSON').addEventListener('click',()=>{
  const blob=new Blob([output.value],{type:'application/json'});
  const a=d.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='wled_pixel_data.json';a.click();
});
</script>
<script>
function exportPixels(pixels,settings){
  const {
    brightness,segment,colorFormat,addressing,outputMode,
    device,ha,colorLimit
  }=settings;
  const col=(hex)=>colorFormat==="dec"
    ? [parseInt(hex.substr(0,2),16),parseInt(hex.substr(2,2),16),parseInt(hex.substr(4,2),16)]
    : hex;

  const segments=[];
  for(let i=0;i<pixels.length;i+=colorLimit){
    const chunk=pixels.slice(i,i+colorLimit);
    const seg={
      on:true,bri:brightness,seg:{id:segment,i:chunk.map(p=>colorFormat==="dec"?col(p.color):`"${p.color}"`)}
    };
    segments.push(JSON.stringify(seg));
  }

  let out="";
  if(outputMode==="wled") out=segments.join("\n");
  if(outputMode==="curl")
    out=segments.map(j=>`curl -X POST "http://${device}/json/state" -H "Content-Type: application/json" -d '${j}'`).join("\n");
  if(outputMode==="ha")
    out=`# Home Assistant
- platform: command_line
  switches:
    ${ha.id}:
      friendly_name: ${ha.name}
      unique_id: ${ha.uid}
      command_on: >
        ${segments.map(j=>`curl -X POST "http://${device}/json/state" -H "Content-Type: application/json" -d '${j}'`).join(" && ")}
      command_off: >
        curl -X POST "http://${device}/json/state" -H "Content-Type: application/json" -d '{"on":false}'`;
  return out;
}
</script>
<script>
function getPixelRGBValues(img){
  const width=parseInt(gId('sizeX').value);
  const height=parseInt(gId('sizeY').value);
  const layout=gId('ledSetupSelector').value;
  const bri=parseInt(gId('brightness').value);
  const outputMode=gId('outputMode').value;
  const colorFormat=gId('colorFormat').value;
  const addressing=gId('addressingMode').value;
  const deviceIP=gId('deviceIP').value;
  const segment=parseInt(gId('segmentID').value);
  const colorLimit=parseInt(gId('colorLimit').value);

  canvas.width=width;canvas.height=height;
  ctx.drawImage(img,0,0,width,height);
  const data=ctx.getImageData(0,0,width,height).data;
  const pixels=[];

  for(let i=0;i<data.length;i+=4){
    const r=data[i],g=data[i+1],b=data[i+2];
    const idx=i/4,row=Math.floor(idx/width),col=idx%width;
    let pos=idx;

    if(layout==="matrix_v_serp"){
      // âœ… jouw verticale lay-out
      pos=col%2===0?col*height+row:col*height+(height-1-row);
    }
    else if(layout==="matrix"){pos=row*width+col;}
    else{
      // horizontale serpentine
      const reverse=(layout==="r2l");
      const dir=(row%2===0?!reverse:reverse);
      pos=dir?(row*width+col):(row*width+(width-1-col));
    }

    const hex=((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
    pixels.push({idx:pos,color:hex});
  }
  pixels.sort((a,b)=>a.idx-b.idx);

  const settings={
    brightness:bri,segment,colorFormat,addressing,outputMode,
    device:deviceIP,ha:{id:"pixel_device",name:"Pixelâ€¯Display",uid:"pixel01"},
    colorLimit
  };
  output.value=exportPixels(pixels,settings);
}
</script>
<script>
// Dynamische segmentâ€‘ophaling (simuleert originele getSegments)
async function getSegments(){
  const ip=gId('deviceIP').value;
  try{
    const res=await fetch(`http://${ip}/json/state`);
    const data=await res.json();
    if(data.seg){
      console.log(`Detected ${data.seg.length} segments from WLED`);
    }
  }catch(e){
    console.warn("Kon geen segmentinformatie ophalen:",e);
  }
}

// Hybrid/range addressing weergave voorbeeld (uitbreidbaar)
function addressingExample(){
  const mode=gId('addressingMode').value;
  let txt="";
  if(mode==="single") txt='["ff0000","00ff00","0000ff"]';
  if(mode==="range")  txt='[10,15,"ff2200"]';
  if(mode==="hybrid") txt='["ffaa00",0,5,"00ff00"]';
  alert(`Voorbeeld voor ${mode} addressing:\n${txt}`);
}
</script>
