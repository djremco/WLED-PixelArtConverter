<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>WLEDâ€¯Pixelâ€¯Artâ€¯Converterâ€¯v2.3</title>
<style>
body{
  font-family:Arial,sans-serif;
  background:#111;
  color:#ddd;
  margin:0;
  padding:20px;
}
.container{max-width:900px;margin:auto;text-align:center}
h1{display:flex;align-items:center;justify-content:center;gap:10px}
table{width:100%;border-collapse:collapse;margin-bottom:10px}
td{padding:6px;vertical-align:middle}
input,select,button{
  background:#222;border:1px solid #333;color:#ddd;
  border-radius:6px;font-size:14px;padding:4px 6px;
}
#drop-zone{
  border:2px dashed #777;color:#888;padding:20px;margin:15px 0;cursor:pointer;
}
textarea{
  width:100%;height:250px;background:#222;color:#ddd;
  border:1px solid #333;border-radius:6px;
  font-family:monospace;padding:8px;margin-top:10px;
}
#pixelCanvas{width:100%;background:#000;border:1px solid #333;margin-top:10px}
.button-row{display:flex;gap:10px;margin-top:10px}
.button-row button{flex:1}
</style>
</head>

<body>
<div class="container">
  <h1>ðŸ§©â€¯WLEDâ€¯Pixelâ€¯Artâ€¯Converterâ€¯v2.3</h1>
  <h2>Verticalâ€¯Serpentineâ€¯+â€¯Wiringâ€¯Directionâ€¯Selector</h2>

  <table>
    <tr>
      <td><label>LEDâ€¯Layout:</label></td>
      <td>
        <select id="ledSetupSelector">
          <option value="matrix">2Dâ€¯Matrixâ€¯(horizontal)</option>
          <option value="r2l">Serpentineâ€¯rowâ€¯â†’â€¯left</option>
          <option value="l2r">Serpentineâ€¯rowâ€¯â†’â€¯right</option>
          <option value="matrix_v_serp" selected>Verticalâ€¯serpentineâ€¯(topâ€‘bottomâ€¯â†‘â†“)</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Outputâ€¯format:</label></td>
      <td>
        <select id="outputMode">
          <option value="wled" selected>WLEDâ€¯JSON</option>
          <option value="curl">CURLâ€¯commands</option>
          <option value="ha">Homeâ€¯Assistantâ€¯YAML</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Colorâ€¯format:</label></td>
      <td>
        <select id="colorFormat">
          <option value="hex" selected>HEXâ€¯("RRGGBB")</option>
          <option value="dec">DECâ€¯(R,G,B)</option>
        </select>
      </td>
    </tr>
    <tr>
      <td><label>Addressingâ€¯mode:</label></td>
      <td>
        <select id="addressingMode">
          <option value="single">Single</option>
          <option value="range">Rangeâ€¯(start,end,color)</option>
          <option value="hybrid" selected>Hybridâ€¯(color,start,end,color)</option>
        </select>
        <button onclick="addressingExample()" style="margin-left:8px">example</button>
      </td>
    </tr>
    <tr><td><label>Brightness:</label></td><td><input type="range" id="brightness" min="1" max="255" value="128"></td></tr>
    <tr><td><label>Maxâ€¯colorsâ€¯/â€¯JSON:</label></td><td><input type="number" id="colorLimit" min="1" max="8192" value="256"></td></tr>
    <tr><td><label>Widthâ€¯(px):</label></td><td><input type="number" id="sizeX" value="23"></td></tr>
    <tr><td><label>Heightâ€¯(px):</label></td><td><input type="number" id="sizeY" value="26"></td></tr>

    <!-- ðŸ§­ nieuwe wiring selector -->
    <tr>
      <td><label>Wiringâ€¯start:</label></td>
      <td>
        <select id="wiringStart">
          <option value="tl" selected>Topâ€‘Leftâ€¯(standaard)</option>
          <option value="tr">Topâ€‘Right</option>
          <option value="bl">Bottomâ€‘Left</option>
          <option value="br">Bottomâ€‘Right</option>
        </select>
      </td>
    </tr>

    <tr><td><label>Deviceâ€¯IP:</label></td><td><input type="text" id="deviceIP" value="192.168.0.100"></td></tr>
    <tr><td><label>Segmentâ€¯ID:</label></td><td><input type="number" id="segmentID" value="0"></td></tr>
  </table>

  <div id="drop-zone">Dropâ€¯imageâ€¯hereâ€¯orâ€¯clickâ€¯toâ€¯upload</div>
  <input type="file" id="file-picker" style="display:none">
  <canvas id="pixelCanvas"></canvas>
  <textarea id="JSONled" readonly></textarea>
  <div class="button-row">
    <button id="copyJSON">Copyâ€¯Output</button>
    <button id="downloadJSON">Downloadâ€¯Output</button>
  </div>
</div>

<!-- ========= JavaScript Section ========= -->
<script>
// --- LoadImage -----------------
function loadImage(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.onload = () => getPixelRGBValues(img);
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

// --- Help functies -------------
const d=document;
function gId(i){return d.getElementById(i);}
const canvas=gId('pixelCanvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});

// --- Upload Events -------------
const dropZone = gId('drop-zone');
const filePicker = gId('file-picker');

// klik in drop-zone opent file dialoog
dropZone.addEventListener("click", () => filePicker.click());

// wanneer iets gekozen wordt
filePicker.addEventListener("change", e => {
  const f = e.target.files[0];
  if (f) loadImage(f);
});

// drag & drop
dropZone.addEventListener("dragover", e => e.preventDefault());
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  const f = e.dataTransfer.files[0];
  if (f) loadImage(f);
});


// --- Copy & Download -----------
gId('copyJSON').onclick=()=>navigator.clipboard.writeText(gId('JSONled').value);
gId('downloadJSON').onclick=()=>{
 const b=new Blob([gId('JSONled').value],{type:'application/json'});
 const a=d.createElement('a');
 a.href=URL.createObjectURL(b);a.download='wled_pixel_data.json';a.click();
};

// --- Export --------------------
function exportPixels(pixels,set){
 const{brightness,segment,colorFormat,outputMode,device,colorLimit}=set;
 const col=h=>colorFormat==="dec"
   ? [parseInt(h.substr(0,2),16),parseInt(h.substr(2,2),16),parseInt(h.substr(4,2),16)]
   : h;
 const chunks=[];
 for(let i=0;i<pixels.length;i+=colorLimit){
   const part=pixels.slice(i,i+colorLimit);
   const seg={
     on:true,bri:brightness,
     seg:{id:segment,i:part.map(p=>colorFormat==="dec"?col(p.color):p.color)}
   };
   chunks.push(seg);
 }
 if(outputMode==="wled"){
   if(chunks.length===1)return JSON.stringify(chunks[0]);
   const merged=chunks.reduce((a,c)=>a.concat(c.seg.i),[]);
   const mergedObj={on:true,bri:brightness,seg:{id:segment,i:merged}};
   return JSON.stringify(mergedObj);
 }
 if(outputMode==="curl")
   return chunks.map(j=>`curl -X POST "http://${device}/json/state" -H "Content-Type: application/json" -d '${JSON.stringify(j)}'`).join("\n");
 if(outputMode==="ha"){
   const merged=chunks.reduce((a,c)=>a.concat(c.seg.i),[]);
   const mergedObj={on:true,bri:brightness,seg:{id:segment,i:merged}};
   return `# Home Assistant YAML
- platform: command_line
  switches:
    pixel_display:
      friendly_name: Pixel Display
      command_on: >
        curl -X POST "http://${device}/json/state" -H "Content-Type: application/json" -d '${JSON.stringify(mergedObj)}'
      command_off: >
        curl -X POST "http://${device}/json/state" -H "Content-Type: application/json" -d '{"on":false}'`;
 }
 return "";
}

// --- Converter / mapping -------
function getPixelRGBValues(img){
 const w=parseInt(gId('sizeX').value);
 const h=parseInt(gId('sizeY').value);
 const layout=gId('ledSetupSelector').value;
 const bri=parseInt(gId('brightness').value);
 const outputMode=gId('outputMode').value;
 const colorFormat=gId('colorFormat').value;
 const addressing=gId('addressingMode').value;
 const device=gId('deviceIP').value;
 const segment=parseInt(gId('segmentID').value);
 const colorLimit=parseInt(gId('colorLimit').value);
 const wiring=gId('wiringStart').value;

 canvas.width=w;canvas.height=h;
 ctx.drawImage(img,0,0,w,h);
 const data=ctx.getImageData(0,0,w,h).data;
 const pixels=[];
 for(let i=0;i<data.length;i+=4){
   const R=data[i],G=data[i+1],B=data[i+2];
   const idx = i / 4;
   const row = Math.floor(idx / w);
   const col = idx % w;
   let pos=idx;

if(layout==="matrix_v_serp"){
  // WLED-compatibele verticale serpentine mapping
  const start = wiring || "tl"; // veiligheid
  let c = col, r = row;
  // Flip horizontaal voor start Right-hoeken
  if(start[1] === "r") c = (w - 1) - col;
  // Flip verticaal voor start Bottom-hoeken
  if(start[0] === "b") r = (h - 1) - row;

// --- WLEDâ€‘compatible horizontal serpentine mapping ---
let colIndex = c;
let rowIndex = r;

// serpentine: om-en-om Lâ†’R / Râ†’L
if (row % 2 === 1) colIndex = (w - 1) - c;

// *belangrijk:* in WLED loopt index horizontaal per rij
pos = rowIndex * w + colIndex;
}

   const hex=((1<<24)+(R<<16)+(G<<8)+B).toString(16).slice(1);
   pixels.push({idx:pos,color:hex});
console.log(`Pixel ${pos} â†’ (${col}, ${row}) Color #${hex}`);

 }
 pixels.sort((a,b)=>a.idx-b.idx);
 const settings={brightness:bri,segment,colorFormat,addressing,outputMode,device,colorLimit};
 const jsonText=exportPixels(pixels,settings);
 gId('JSONled').value=jsonText;
 try{drawPixelOverlay(pixels,w,h,layout);}catch(e){console.warn("Overlay kon niet getekend worden:",e.message);}
}

// --- voorbeeld & API ----------
function addressingExample(){
 const m=gId('addressingMode').value;
 let t="";
 if(m==="single")t='["ff0000","00ff00","0000ff"]';
 if(m==="range")t='[10,15,"ffaa00"]';
 if(m==="hybrid")t='["ffaa00",0,5,"00ff00"]';
 alert(`Voorbeeldâ€¯(${m})â€¯â†’â€¯${t}`);
}
async function getSegments(){
 const ip=gId('deviceIP').value;
 try{const r=await fetch(`http://${ip}/json/state`);
     const j=await r.json();
     if(j.seg)console.log("Segments:",j.seg.length,j.seg);
 }catch(e){console.warn("Segmentâ€¯APIâ€¯error:",e);}
}

// --- overlay -----------------
function drawPixelOverlay(pixels, w, h, layout) {
  const start = gId("wiringStart").value;
  const c2 = canvas.getContext("2d");
  const step = Math.max(6, Math.floor(window.innerWidth / (w * 2)));
  canvas.width = w * step;
  canvas.height = h * step;
  c2.clearRect(0, 0, canvas.width, canvas.height);

  for (let col = 0; col < w; col++) {
    for (let row = 0; row < h; row++) {
      let c = col;
      let r = row;

      // flips voor start-hoeken
      if (start[1] === "r") c = (w - 1) - col;
      if (start[0] === "b") r = (h - 1) - row;

      // serpentine kolommen: even/oneven omgedraaid
      let colIndex = c;
      let rowIndex = r;
      if ((start[1] === "r")
            ? ((w - 1 - col) % 2 === 1)
            : (col % 2 === 1)) {
        rowIndex = (h - 1) - r;
      }

      const idx = colIndex * h + rowIndex;
      const p = pixels.find(px => px.idx === idx);
      const colr = p ? p.color : "000000";

      // pixelvakje tekenen
      c2.fillStyle = "#" + colr;
      c2.fillRect(col * step, row * step, step, step);
      c2.strokeStyle = "#333";
      c2.strokeRect(col * step, row * step, step, step);
      c2.fillStyle = "#aaa";
      c2.font = `${Math.max(6, step / 2)}px Arial`;
      c2.textAlign = "center";
      c2.textBaseline = "middle";
      c2.fillText(idx, col * step + step / 2, row * step + step / 2);
    }
  }
}

</script>
</body>
</html>
